# docker-ubuntu-android-nativescript-vue

Setting up an android development environment is time-consuming and may change from machine to machine.
Docker lets me reproduce my development environment everywhere with a one liner.

Here the goal is:
- Developing on my host (with my preferred IDE and so on)
- Building and running application inside my docker container but as I had everything installed on my host

# Setup environment

## Setup host and scaffold the project

Standard nativescript-vue project initialization:

```
npm install -g @vue/cli @vue/cli-init
vue init nativescript-vue/vue-cli-template <you project>
cd <your project>
npm install
```

Now you host is ready, you have a nativescript-vue project and you can start developing


## Run the app inside the container

Building and running your app was the hard setup part.
But now you can simply issue this commands:

```
curl -LJ \
     -O https://raw.githubusercontent.com/andreav/docker-ubuntu-android-nativescript-vue/master/Dockerfile \
     -O https://raw.githubusercontent.com/andreav/docker-ubuntu-android-nativescript-vue/master/.dockerignore

docker build -t img-and-ubu-ns-vue \
             --build-arg USER_ID=$(id -u) \
             --build-arg GROUP_ID=$(id -g) \
             .

docker run --name nsvue \
           -it -d --privileged \
           -u $( id -u):$(id -g) \
           -v /dev/bus/usb:/dev/bus/usb \
           -v ${PWD}/app:/usr/src/app \
           -v /usr/src/app/node_modules \
           img-and-ubu-ns-vue

alias tns='docker exec -it nsvue tns'
tns build android --bundle
tns run android --bundle
```

With these command you are:

- Getting Dockerfile and .dockerignore files into your project
- Building ubuntu-android-nativescript image
  - ubuntu 18.04 is the base
  - java 8 openjdj is installed
  - android-28 SDK is installed
  - nativescript is installed 

- Building ubuntu-android-nativescript-vue on top of the previous one
  - a user with the same uid:gid from the host is created in the container
  - package.json is copied 
  - npm install downloads all packaged (included nativescript-vue)

- Run a container named 'nsvue' as the build environment:
  - running with same uid:gid as host user. So, generated files inside the container (i.e. "target" folder containing apk) will appear on the host as created by the host user
  - mounting source code
  - using --privileged and mount /dev/bus/usb for installing apk on the device
  - mounting node_modules as container volume to avoid overwriting host node_modules

- Creating an alias for using tns as if it was installed on the host machine

- Building project for android

- Running the app on a device connected to the host

If you now change source files from host machine, your app will reflect changes on the phone.

## Installing new node packages

Every time you need to install a new node package you should:

- Install it as usual on the host

- Install it also in teh container, issuing:

`docker exec -it docker exec -it nsvue npm install`

# Security

## User management

Sharing code from host to container and receiving artifacts from container to host means mixing users among two worlds.

This image follows these guidelines:

- Running container as NON ROOT, as from best practices
- Creating a user with same uid:gid as host user into container
- Running container with host uid:gid

In this way host and container user differences are harmonized and files generated by one or the other world seem the same.

## privileged flag

This flag is mandatory for mounting /dev/bus/usb
However user inside container is NOT ROOT (unless you build this image as root) so kernel will grant to the container user the same rights your host user will have.

# Dockerfile

It uses multistage Dockerfile.
So it's:
- All in 1 file, nice
- Stage 0 is a plain ubuntu / android / nativescript image, so anyone can reuse it as it is, or s a base for installing another supported framework (for instance angular)
You can build this base image by:

    `docker build --target ubuntunativescript . -t ubu-ns`

- Stage 1 adds nativescript-vue and source code
This stage can be built as the target Dockerfile image like this:

    `docker build . -t ubu-ns-vue`


# Useful Commands

- `docker build --target ubuntunativescript . -t img-ubu-ns`
As mentioned before, this command lets you build a pure nativescript image (the first stage of the docker file)

- `docker run -it --rm img-ubu-ns`
Once built the pure nativescript image, you can run it. Some diag messages will be presented on stdout, thanks to @kristophjunge for the shell script.

- `docker build --target ubuntunativescript . -t img-ubu-ns-vue`
This command lets you build a nativescript-vue image, and copies the source code into the container. 
With the next command you can the log into the container and play with nativescirpt-vue

- `docker run -it --rm -v /dev/bus/usb:/dev/bus/usb img-ubu-ns-vue bash`
Issue this command to work directly inside a nativescript-vue environment inside your container
Source code is inside /usr/src/app
For instance you can build and manually run your app:
  - tns build android --bundle
  - tns run android --bundle

# References

- https://github.com/kristophjunge/docker-nativescript

- https://docs.nativescript.org/start/ns-setup-linux

- https://dev.to/alex_barashkov/using-docker-for-nodejs-in-development-and-production-3cgp
