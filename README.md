# docker-ubuntu-android-nativescript-vue

Setting up an android development environment is time-consuming and may change from machine to machine.
Docker lets me reproduce my development environment everywhere with a one liner.

Here the goal is:
- Developing on my host (with my preferred IDE and so on)
- Building and running application inside my docker container but as I had everything installed on my host

# Setup environment

## Setup host and scaffold the project

Standard nativescript-vue project initialization:

```
npm install -g @vue/cli @vue/cli-init
vue init nativescript-vue/vue-cli-template <you project>
cd <your project>
npm install
```

Now you host is ready, you have a nativescript-vue project and you can start developing


## Run the app inside the container

Building and running your app was the hard setup part.
But now you can simply issue this commands (from the root of the project):

```
curl -LJ \
     -O https://raw.githubusercontent.com/andreav/docker-ubuntu-android-nativescript-vue/master/Dockerfile \
     -O https://raw.githubusercontent.com/andreav/docker-ubuntu-android-nativescript-vue/master/.dockerignore

docker build -t img-and-ubu-ns-vue \
             --build-arg USER_ID=$(id -u) \
             --build-arg GROUP_ID=$(id -g) \
             .

docker run --name nsvue \
           -it -d --privileged \
           -u $( id -u):$(id -g) \
           -v /dev/bus/usb:/dev/bus/usb \
           -v ${PWD}:/usr/src/app \
           -v /usr/src/app/node_modules \
           img-and-ubu-ns-vue

docker exec -it nsvue npm install

alias tns='docker exec -it nsvue tns'
tns build android --bundle
tns run android --bundle
```

With these command you are:

- Getting Dockerfile and .dockerignore files into your project
You need to build dockerfile locally for creating the right user inside the container

- Downloading andreav/ubuntu-android-nativescript image
  - ubuntu 18.04 is the base
  - java 8 openjdj is installed
  - android-28 SDK is installed
  - nativescript is installed 

- Building ubuntu-android-nativescript-vue on top of the previous one
  - a user with the same uid:gid from the host is created in the container

- Run a container named 'nsvue' as the build environment:
  - running with same uid:gid as host user. So, generated files inside the container (i.e. "target" folder containing apk) will appear on the host as created by the host user
  - mounting source code
  - using --privileged and mount /dev/bus/usb for installing apk on the device
  - mounting node_modules as container volume to avoid overwriting host node_modules

- npm install packages

- Creating an alias for using tns as if it was installed on the host machine

- Building project for android

- Running the app on a device connected to the host

If you now change source files from host machine, your app will reflect changes on the phone.

## Installing new node packages

Every time you need to install a new node package you should:

- Install it as usual on the host

- Install it also in teh container, issuing:

`docker exec -it nsvue npm install`

# Security

## User management

Sharing code from host to container and receiving artifacts from container to host means mixing users among two worlds.

This image follows these guidelines:

- Running container as NON ROOT, as from best practices
- Creating a user with same uid:gid as host user into container
- Running container with host uid:gid

In this way host and container user differences are harmonized and files generated by one or the other world seem the same.

## privileged flag

This flag is mandatory for mounting /dev/bus/usb
However user inside container is NOT ROOT (unless you build this image as root) so kernel will grant to the container user the same rights your host user will have.

# References

- https://dev.to/alex_barashkov/using-docker-for-nodejs-in-development-and-production-3cgp
